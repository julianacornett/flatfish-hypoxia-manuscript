---
title: "Metabolic Plots - Linear Model & Scatterplots"
author: "Juliana Cornett"
date: "1/13/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#install required packages (tidyverse & ggpubr)

```{r}
#install.packages("tidyverse")
#install.packages("ggpubr")
#install.packages("segmented")
```

#load libraries

```{r}
library(tidyverse)
library(ggpubr)
library(segmented)
```

#DATA PREPARATION

#read in CSV files with MMR & SMR data for English sole at each DO level

```{r}
sole_scope <- read.csv("Englishsole_Metabolic.csv")
```

#create new ambient and hypoxic aerobic scope columns by subtracting MMR - SMR

```{r}
sole_scope$AmbScope <- (sole_scope$AmbMMR - sole_scope$AmbSMR)
sole_scope$HypScope <- (sole_scope$HypMMR - sole_scope$HypSMR)
```

#create aerobic scope difference column by subtracting hypoxic - ambient scope

```{r}
sole_scope$ScopeChange <- (sole_scope$HypScope - sole_scope$AmbScope)
```

#add MMR change and SMR change columns to scope dataframe

```{r}
sole_scope$MMRChange <- (sole_scope$HypMMR - sole_scope$AmbMMR)
sole_scope$SMRChange <- (sole_scope$HypSMR - sole_scope$AmbSMR)
```

#remove negative scope values (SMR or MMR not achieved)

```{r}
sole_scope_sub <- subset(sole_scope, sole_scope$AmbScope >= 0 & sole_scope$HypScope >= 0)
sole_scope_sub
```

#group and calculate means

```{r}
sole_scope_grouped <- sole_scope_sub %>% group_by(DO_mgL) %>% summarise(HypMMRAvg = mean(HypMMR, na.rm = TRUE), HypMMRVar = var(HypMMR, na.rm = TRUE), HypSMRAvg = mean(HypSMR, na.rm = TRUE), HypSMRVar = var(HypSMR, na.rm = TRUE), HypScopeAvg = mean(HypScope, na.rm = TRUE), HypScopeVar = var(HypScope, na.rm = TRUE))
sole_scope_grouped
```
#linear models for variance

```{r}
MMR_var <- lm(sole_scope_grouped$HypMMRVar ~ sole_scope_grouped$DO_mgL)
print(summary(MMR_var))

SMR_var <- lm(sole_scope_grouped$HypSMRVar ~ sole_scope_grouped$DO_mgL)
print(summary(SMR_var))

Scope_var <- lm(sole_scope_grouped$HypScopeVar ~ sole_scope_grouped$DO_mgL)
print(summary(Scope_var))
```

#linear models

#post SMR

```{r}
post_SMR <- lm(sole_scope_sub$HypSMR ~ sole_scope_sub$DO_mgL)
print(summary(post_SMR))
```
#broken stick regression for SMR

```{r}
smr_lm <- lm(HypSMR ~ DO_mgL, data = sole_scope_sub)
smr_segmented <- segmented(smr_lm, seg.Z = ~DO_mgL)
print(summary(smr_segmented))

dat_smr_broken = data.frame(x = sole_scope_sub$DO_mgL, y = broken.line(smr_segmented)$fit)

ggplot(sole_scope_sub, aes(x = DO_mgL, y = HypSMR)) +
  geom_point() +
  geom_line(data = dat_smr_broken, aes(x = x, y = y),color = 'blue')
```

#change SMR

```{r}
change_SMR <- lm(sole_scope_sub$SMRChange ~ sole_scope_sub$DO_mgL)
print(summary(change_SMR))
```

#broken stick regression for SMR change

```{r}
smrChange_lm <- lm(SMRChange ~ DO_mgL, data = sole_scope_sub)
smrChange_segmented <- segmented(smrChange_lm, seg.Z = ~DO_mgL)
print(summary(smrChange_segmented))

dat_smrChange_broken = data.frame(x = sole_scope_sub$DO_mgL, y = broken.line(smrChange_segmented)$fit)

ggplot(sole_scope_sub, aes(x = DO_mgL, y = SMRChange)) +
  geom_point() +
  geom_line(data = dat_smrChange_broken, aes(x = x, y = y),color = 'blue')
```

#post MMR

```{r}
post_MMR <- lm(sole_scope_sub$HypMMR ~ sole_scope_sub$DO_mgL)
print(summary(post_MMR))
```

#change MMR

```{r}
change_MMR <- lm(sole_scope_sub$MMRChange ~ sole_scope_sub$DO_mgL)
print(summary(change_MMR))
```

#post scope

```{r}
post_scope <- lm(sole_scope_sub$HypScope ~ sole_scope_sub$DO_mgL)
print(summary(post_scope))
```

#change scope

```{r}
change_scope <- lm(sole_scope_sub$ScopeChange ~ sole_scope_sub$DO_mgL)
print(summary(change_scope))
```

#POST-EXPOSURE + CHANGE SCATTERPLOTS with PATCHWORK (Figure 3 in manuscript)

```{r}
SMR_Post_p1 <- ggplot(sole_scope_sub, aes(x = DO_mgL, y = HypSMR)) +
  geom_point(fill = "lightskyblue1", shape = 21, size = 5) +
  theme_pubr() +
  geom_line(data = dat_smr_broken, aes(x = x, y = y),color = "black") +
  geom_text(aes(x=6.85, y=350, label= "R^2 == 0.16~~~p == 0.25"), size=6, parse = TRUE) +
  theme(axis.text = element_text(size=14), axis.title = element_text(size=16, face="bold")) + 
  xlab(NULL) +
  ylab("Post-exposure SMR (mgO2/kg/hr)")

SMR_Change_p2 <- ggplot(sole_scope_sub, aes(x = DO_mgL, y = SMRChange)) +
  geom_point(fill = "lightskyblue1", shape = 21, size = 5) +
  theme_pubr() +
  geom_line(data = dat_smrChange_broken, aes(x = x, y = y),color = "black") +
  geom_text(aes(x=6.85, y=75, label= "R^2 == 0.25~~~p == 0.27"), size=6, parse = TRUE) +
  theme(axis.text = element_text(size=14), axis.title = element_text(size=16, face="bold")) +
  geom_hline(yintercept=0, linetype='dotted') + 
  xlab(NULL) +
  ylab("Change in SMR (mgO2/kg/hr)")

MMR_Post_p3 <- ggplot(sole_scope_sub, aes(x = DO_mgL, y = HypMMR)) +
  geom_point(fill = "lightskyblue1", shape = 21, size = 5) +
  theme_pubr() +
  geom_smooth(method = "lm", color ="black", se = FALSE) +
  geom_text(aes(x=6.85, y=675, label= "R^2 == 0.11~~~p == 0.09"), size=6, parse = TRUE) +
  theme(axis.text = element_text(size=14), axis.title = element_text(size=16, face="bold")) + 
  xlab(NULL) +
  ylab("Post-exposure MMR (mgO2/kg/hr)")

MMR_Change_p4 <- ggplot(sole_scope_sub, aes(x = DO_mgL, y = MMRChange)) +
  geom_point(fill = "lightskyblue1", shape = 21, size = 5) +
  theme_pubr() +
  geom_smooth(method = "lm", color ="black", se = FALSE) +
  geom_text(aes(x=6.85, y=300, label= "R^2 == 0.32~~~p == 0.002"), size=6, parse = TRUE) +
  theme(axis.text = element_text(size=14), axis.title = element_text(size=16, face="bold")) +
  geom_hline(yintercept=0, linetype='dotted') + 
  xlab(NULL) +
  ylab("Change in MMR (mgO2/kg/hr)")

Scope_Post_p5 <- ggplot(sole_scope_sub, aes(x = DO_mgL, y = HypScope)) +
  geom_point(fill = "lightskyblue1", shape = 21, size = 5) +
  theme_pubr() +
  geom_smooth(method = "lm", color ="black", se = FALSE) +
  geom_text(aes(x=6.85, y=400, label= "R^2 == 0.23~~~p == 0.01"), size=6, parse = TRUE) +
  theme(axis.text = element_text(size=14), axis.title = element_text(size=16, face="bold")) + 
  xlab("DO (mg/L)") +
  ylab("Post-exposure Aerobic Scope (mgO2/kg/hr)")

Scope_Change_p6 <- ggplot(sole_scope_sub, aes(x = DO_mgL, y = ScopeChange)) +
  geom_point(fill = "lightskyblue1", shape = 21, size = 5) +
  theme_pubr() +
  geom_smooth(method = "lm", color ="black", se = FALSE) +
  geom_text(aes(x=6.85, y=400, label= "R^2 == 0.24~~~p == 0.01"), size=6, parse = TRUE) +
  theme(axis.text = element_text(size=14), axis.title = element_text(size=16, face="bold")) +
  geom_hline(yintercept=0, linetype='dotted') + 
  xlab("DO (mg/L)") +
  ylab("Change in Aerobic Scope (mgO2/kg/hr)")

jpeg("EnglishSole_MetabolicScatterplots.jpg", width = 14, height = 14, units="in", res=1200)
(SMR_Post_p1 | SMR_Change_p2)/
  (MMR_Post_p3 | MMR_Change_p4)/
  (Scope_Post_p5 | Scope_Change_p6)
```
